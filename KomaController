using UnityEngine;
using System.Threading.Tasks;

public class KomaController : MonoBehaviour
{
    public GameObject KomaLine;
    public GameObject UpYajirushi;
    public GameObject RightUpYajirushi;
    public GameObject LeftUpYajirushi;
    public GameObject DownYajirushi;
    public GameObject RightDownYajirushi;
    public GameObject LeftDownYajirushi;
    public GameObject RightYajirushi;
    public GameObject LeftYajirushi;
    public GameObject kemuri1;
    public GameObject kemuri2;
    public GameObject kemuri3;
    public GameObject kemuri4;
    public GameObject kemuri5;
    public GameObject kemuri6;
    public GameObject KomaOushou;
    public GameObject KomaKakugyou;
    public GameObject KomaHisha;
    public GameObject KomaHuhyou;
    public GameObject KomaKinshou;
    public GameObject KomaGinshou;
    public GameObject KomaKeima;
    public GameObject KomaKyousha;
    public GameObject Number0;
    public GameObject Number1;
    public GameObject Number2;
    public GameObject Number3;
    public GameObject Number4;
    public GameObject Number5;
    public GameObject Number6;
    public GameObject Number7;
    public GameObject Number8;
    public GameObject Number9;
    
    private Rigidbody2D rb;
    private GameObject currentKomaLine;
    private GameObject currentUpYajirushi;
    private GameObject currentRightUpYajirushi;
    private GameObject currentLeftUpYajirushi;
    private GameObject currentDownYajirushi;
    private GameObject currentRightDownYajirushi;
    private GameObject currentLeftDownYajirushi;
    private GameObject currentRightYajirushi;
    private GameObject currentLeftYajirushi;
    private GameObject currentkemuri1;
    private GameObject currentkemuri2;
    private GameObject currentkemuri3;
    private GameObject currentkemuri4;
    private GameObject currentkemuri5;
    private GameObject currentkemuri6;
    private GameObject currentKomaOushou;
    private GameObject currentKomaKakugyou;
    private GameObject currentKomaHisha;
    private GameObject currentKomaHuhyou;
    private GameObject currentKomaKinshou;
    private GameObject currentKomaGinshou;
    private GameObject currentKomaKeima;
    private GameObject currentKomaKyousha;
    private GameObject currentNumber0;
    private GameObject currentNumber1;
    private GameObject currentNumber2;
    private GameObject currentNumber3;
    private GameObject currentNumber4;
    private GameObject currentNumber5;
    private GameObject currentNumber6;
    private GameObject currentNumber7;
    private GameObject currentNumber8;
    private GameObject currentNumber9;

    
    bool wolkFlag = true,movePanelFlag = false,komaPanelFlag = false;
    bool upFlag,downFlag,rightFlag,leftFlag,rightupFlag,rightdownFlag,leftupFlag,leftdownFlag;
    public int oushouCount = 0,kakugyouCount = 0,hishaCount = 0,huhyouCount = 0,kinshouCount = 0,ginshouCount = 0,keimaCount = 0,kyoushaCount = 0;
    private GameObject[] NumberArray;
    float x,y,z;
    float mA = 1.0f; //as MoveAmount
    float wolkSpeed = 0.01f;
    public Sprite[] changeSprites;
    SpriteRenderer spriteRenderer;


    void Start()
    {
        Application.targetFrameRate = 240;
        FlagOff();//フラグの初期化
        rb = this.GetComponent<Rigidbody2D>();
        this.spriteRenderer = GetComponent<SpriteRenderer>();
    }

    async Task Update()
    {
        if (Input.GetKeyDown(KeyCode.Q))
        {
            MoveFunction(-1*mA, mA, 0);
            ChangeFunction("Hisha");
        }
        if (Input.GetKeyDown(KeyCode.W))
        {
            MoveFunction(0, mA, 0);
            ChangeFunction("Oushou");
        }
        if (Input.GetKeyDown(KeyCode.E))
        {
            MoveFunction(mA, mA, 0);
            ChangeFunction("Kakugyou");
        }
        if (Input.GetKeyDown(KeyCode.A))
        {
            MoveFunction(-1*mA, 0, 0);
            ChangeFunction("Kyousha");
        }
        if (Input.GetKey(KeyCode.A))
        {
            if(wolkFlag == true)
            {
                transform.Translate(-1*wolkSpeed,0,0);
            }
        }
        if (Input.GetKeyDown(KeyCode.D))
        {
            MoveFunction(mA, 0, 0);
            ChangeFunction("Keima");
        }
        if (Input.GetKey(KeyCode.D))
        {
            if(wolkFlag == true)
            {
                transform.Translate(wolkSpeed,0,0);
            }
        }
        if (Input.GetKeyDown(KeyCode.Z))
        {
            MoveFunction(-1*mA, -1*mA, 0);
            ChangeFunction("Ginshou");
        }
        if (Input.GetKeyDown(KeyCode.X))
        {
            MoveFunction(0, -1*mA, 0);
            ChangeFunction("Huhyou");
        }
        if (Input.GetKeyDown(KeyCode.C))
        {
            MoveFunction(mA, -1*mA, 0);
            ChangeFunction("Kinshou");
        }
        if (Input.GetKeyDown(KeyCode.S))//Sキーの処理
        {
            if(movePanelFlag == false)
            {
                //フラグの反転
                wolkFlag = !wolkFlag;
                //座標の確認
                Vector3 myPosition = transform.position;
                x = transform.position.x;
                y = transform.position.y;
                z = transform.position.z;
                if(wolkFlag == false)
                {
                    this.OpenKomaPanel();
                }
                else if(wolkFlag == true)
                {
                    this.CloseKomaPanel();
                    //動きの再開
                    StartMove();
                }
            }
        }
        if (Input.GetKeyDown(KeyCode.Space))//スペースキーの処理
        {
            if(komaPanelFlag == false)
            {
                //フラグの反転
                wolkFlag = !wolkFlag;
                //座標の確認
                Vector3 myPosition = transform.position;
                x = transform.position.x;
                y = transform.position.y;
                z = transform.position.z;
                if(wolkFlag == false)
                {
                    this.OpenMovePanel();
                }
                else if(wolkFlag == true)
                {
                    this.CloseMovePanel();
                }
            }
        }
        if (Input.GetKeyDown(KeyCode.P))
        {
            ChangeAnimation("Oushou");
        }
    }
    public void StopMove()//運動停止
    {
        rb.bodyType = RigidbodyType2D.Kinematic;//動きの固定
        rb.linearVelocity = Vector2.zero;
        rb.angularVelocity = 0f;
    }

    public void StartMove()//運動再開
    {
        rb.bodyType = RigidbodyType2D.Dynamic;
    }

    public void OpenMovePanel()//移動パネルの展開
    {
        movePanelFlag = true;
        //動きを止める
        StopMove();
        //特殊パネルの出現
        currentKomaLine = Instantiate(KomaLine);
        currentKomaLine.transform.position = new Vector3(x,y,z);
        //矢印の出現
        currentUpYajirushi = Instantiate(UpYajirushi);
        currentUpYajirushi.transform.position = new Vector3(x,y+1f,z);

        currentRightUpYajirushi = Instantiate(RightUpYajirushi);
        currentRightUpYajirushi.transform.position = new Vector3(x+0.9f,y+0.9f,z);

        currentLeftUpYajirushi = Instantiate(LeftUpYajirushi);
        currentLeftUpYajirushi.transform.position = new Vector3(x-0.9f,y+0.9f,z);

        currentDownYajirushi = Instantiate(DownYajirushi);
        currentDownYajirushi.transform.position = new Vector3(x,y-1f,z);

        currentRightDownYajirushi = Instantiate(RightDownYajirushi);
        currentRightDownYajirushi.transform.position = new Vector3(x+0.9f,y-0.9f,z);

        currentLeftDownYajirushi = Instantiate(LeftDownYajirushi);
        currentLeftDownYajirushi.transform.position = new Vector3(x-0.9f,y-0.9f,z);

        currentRightYajirushi = Instantiate(RightYajirushi);
        currentRightYajirushi.transform.position = new Vector3(x+1f,y,z);

        currentLeftYajirushi = Instantiate(LeftYajirushi);
        currentLeftYajirushi.transform.position = new Vector3(x-1f,y,z);
    }

    public void CloseMovePanel()//移動パネルを閉じる
    {
        //動きの再開
        StartMove();
        //タグ(OverLayer)の削除
        DestroyOverLayer();
        movePanelFlag = false;
    }

    public void OpenKomaPanel()//駒パネルの展開
    {
        komaPanelFlag = true;
        //動きを止める
        StopMove();
        //特殊パネルの出現
        currentKomaLine = Instantiate(KomaLine);
        currentKomaLine.transform.position = new Vector3(x,y,z);
        //駒選択肢の出現
        currentKomaOushou = Instantiate(KomaOushou);
        currentKomaOushou.transform.position = new Vector3(x,y+1.1f,z);
        NumberView("Oushou",x,y,z);

        currentKomaKakugyou = Instantiate(KomaKakugyou);
        currentKomaKakugyou.transform.position = new Vector3(x+1.1f,y+1.1f,z);
        NumberView("Kakugyou",x,y,z);

        currentKomaHisha = Instantiate(KomaHisha);
        currentKomaHisha.transform.position = new Vector3(x-1.1f,y+1.1f,z);
        NumberView("Hisha",x,y,z);

        currentKomaHuhyou = Instantiate(KomaHuhyou);
        currentKomaHuhyou.transform.position = new Vector3(x,y-1.1f,z);
        NumberView("Huhyou",x,y,z);

        currentKomaKinshou = Instantiate(KomaKinshou);
        currentKomaKinshou.transform.position = new Vector3(x+1.1f,y-1.1f,z);
        NumberView("Kinshou",x,y,z);

        currentKomaGinshou = Instantiate(KomaGinshou);
        currentKomaGinshou.transform.position = new Vector3(x-1.1f,y-1.1f,z);
        NumberView("Ginshou",x,y,z);

        currentKomaKeima = Instantiate(KomaKeima);
        currentKomaKeima.transform.position = new Vector3(x+1.1f,y,z);
        NumberView("Keima",x,y,z);

        currentKomaKyousha = Instantiate(KomaKyousha);
        currentKomaKyousha.transform.position = new Vector3(x-1.1f,y,z);
        NumberView("Kyousha",x,y,z);
    }

    public void CloseKomaPanel()//駒パネルを閉じる
    {
        //タグ(OverLayer)の削除
        DestroyOverLayer();
        komaPanelFlag = false;
    }

    public void NumberView(string komamei,float x,float y,float z)//所持駒の表示
    {
        NumberArray = new GameObject[]{Instantiate(Number0),Instantiate(Number1),Instantiate(Number2),Instantiate(Number3)
        ,Instantiate(Number4),Instantiate(Number5),Instantiate(Number6),Instantiate(Number7),Instantiate(Number8),Instantiate(Number9)};
        switch (komamei)
        {
            case "Oushou":
                NumberArray[oushouCount].transform.position = new Vector3(x,y+1.1f,z);
                break;
            case "Kakugyou":
                NumberArray[kakugyouCount].transform.position = new Vector3(x+1.1f,y+1.1f,z);
                break;
            case "Hisha":
                NumberArray[hishaCount].transform.position = new Vector3(x-1.1f,y+1.1f,z);
                break;
            case "Huhyou":
                NumberArray[huhyouCount].transform.position = new Vector3(x,y-1.1f,z);
                break;
            case "Kinshou":
                NumberArray[kinshouCount].transform.position = new Vector3(x+1.1f,y-1.1f,z);
                break;
            case "Ginshou":
                NumberArray[ginshouCount].transform.position = new Vector3(x-1.1f,y-1.1f,z);
                break;
            case "Keima":
                NumberArray[keimaCount].transform.position = new Vector3(x+1.1f,y,z);
                break;
            case "Kyousha":
                NumberArray[kyoushaCount].transform.position = new Vector3(x-1.1f,y,z);
                break;
            default:
                Debug.Log("Number ERRER : " + komamei + " 残駒数カウント");
                break;
        }
    }

    public void MoveFunction(float x,float y,float z)
    {
        if(movePanelFlag == true)//ここら辺関数化したいね
        {
            wolkFlag = !wolkFlag;
            this.CloseMovePanel();
            transform.Translate(x, y, z);
        }
    }

    public void ChangeFunction(string komamei)//駒の見た目変更
    {
        if(komaPanelFlag == true)
        {
            //フラグの反転
            wolkFlag = !wolkFlag;
            CloseKomaPanel();
            ChangeAnimation(komamei);
        }
    }

    public void DestroyOverLayer()//タグ(OverLayer)の削除
    {
        GameObject[] objects = GameObject.FindGameObjectsWithTag("OverLayer");
        foreach(GameObject chinko in objects)
        {
            Destroy(chinko);
        }
    }

    public async Task ChangeAnimation(string komamei)
    {
        wolkFlag = false;
        Vector3 myPosition = transform.position;
        x = transform.position.x;
        y = transform.position.y;
        z = transform.position.z;
        currentkemuri1 = Instantiate(kemuri1);///////配列化して短くできる
        currentkemuri1.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri1);
        currentkemuri1 = null;
        currentkemuri2 = Instantiate(kemuri2);
        currentkemuri2.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri2);
        currentkemuri2 = null;
        currentkemuri3 = Instantiate(kemuri3);
        currentkemuri3.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri3);
        currentkemuri3 = null;
        currentkemuri4 = Instantiate(kemuri4);
        currentkemuri4.transform.position = new Vector3(x,y,z);
        //変身部分
        switch (komamei)
        {
            case "Oushou":
                this.spriteRenderer.sprite = this.changeSprites[0];
                break;
            case "Kakugyou":
                this.spriteRenderer.sprite = this.changeSprites[1];
                break;
            case "Hisha":
                this.spriteRenderer.sprite = this.changeSprites[2];
                break;
            case "Huhyou":
                this.spriteRenderer.sprite = this.changeSprites[3];
                break;
            case "Kinshou":
                this.spriteRenderer.sprite = this.changeSprites[4];
                break;
            case "Ginshou":
                this.spriteRenderer.sprite = this.changeSprites[5];
                break;
            case "Keima":
                this.spriteRenderer.sprite = this.changeSprites[6];
                break;
            case "Kyousha":
                this.spriteRenderer.sprite = this.changeSprites[7];
                break;
            default:
                Debug.Log("Sprite ERRER");
                break;
        }

        await Task.Delay(100);
        Destroy(currentkemuri4);
        currentkemuri4 = null;
        currentkemuri5 = Instantiate(kemuri5);
        currentkemuri5.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri5);
        currentkemuri5 = null;
        currentkemuri6 = Instantiate(kemuri6);
        currentkemuri6.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri6);
        currentkemuri6 = null;
        //動きの再開
        StartMove();
        wolkFlag = true;
    }
    public void FlagOff()
    {
        upFlag = false;
        downFlag = false;
        rightFlag = false;
        leftFlag = false;
        rightdownFlag = false;
        rightupFlag = false;
        leftupFlag = false;
        leftdownFlag = false;
    }
}
