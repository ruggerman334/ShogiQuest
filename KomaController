using UnityEngine;
using System.Threading;
using System.Threading.Tasks;
using System.Collections.Generic;


public class KomaController : MonoBehaviour
{
    public GameObject KomaLine;
    public GameObject UpYajirushi;
    public GameObject RightUpYajirushi;
    public GameObject LeftUpYajirushi;
    public GameObject DownYajirushi;
    public GameObject RightDownYajirushi;
    public GameObject LeftDownYajirushi;
    public GameObject RightYajirushi;
    public GameObject LeftYajirushi;
    public GameObject kemuri1;
    public GameObject kemuri2;
    public GameObject kemuri3;
    public GameObject kemuri4;
    public GameObject kemuri5;
    public GameObject kemuri6;
    public GameObject KomaOushou;
    public GameObject KomaKakugyou;
    public GameObject KomaHisha;
    public GameObject KomaHuhyou;
    public GameObject KomaKinshou;
    public GameObject KomaGinshou;
    public GameObject KomaKeima;
    public GameObject KomaKyousha;
    public GameObject Number0;
    public GameObject Number1;
    public GameObject Number2;
    public GameObject Number3;
    public GameObject Number4;
    public GameObject Number5;
    public GameObject Number6;
    public GameObject Number7;
    public GameObject Number8;
    public GameObject Number9;
    
    private Rigidbody2D rb;
    private GameObject currentKomaLine;
    private GameObject currentUpYajirushi;
    private GameObject currentRightUpYajirushi;
    private GameObject currentLeftUpYajirushi;
    private GameObject currentDownYajirushi;
    private GameObject currentRightDownYajirushi;
    private GameObject currentLeftDownYajirushi;
    private GameObject currentRightYajirushi;
    private GameObject currentLeftYajirushi;
    private GameObject currentkemuri1;
    private GameObject currentkemuri2;
    private GameObject currentkemuri3;
    private GameObject currentkemuri4;
    private GameObject currentkemuri5;
    private GameObject currentkemuri6;
    private GameObject currentKomaOushou;
    private GameObject currentKomaKakugyou;
    private GameObject currentKomaHisha;
    private GameObject currentKomaHuhyou;
    private GameObject currentKomaKinshou;
    private GameObject currentKomaGinshou;
    private GameObject currentKomaKeima;
    private GameObject currentKomaKyousha;
    private GameObject currentNumber0;
    private GameObject currentNumber1;
    private GameObject currentNumber2;
    private GameObject currentNumber3;
    private GameObject currentNumber4;
    private GameObject currentNumber5;
    private GameObject currentNumber6;
    private GameObject currentNumber7;
    private GameObject currentNumber8;
    private GameObject currentNumber9;

    
    bool wolkFlag = true,movePanelFlag = false,komaPanelFlag = false;
    bool upFlag,downFlag,rightFlag,leftFlag,rightupFlag,rightdownFlag,leftupFlag,leftdownFlag;
    bool collisionFlag = false;
    string nowKomamei;
    public Dictionary<string, int> Count = new Dictionary<string, int>
    {
        {"Oushou",0},{"Kakugyou",0},{"Hisha",0},{"Huhyou",0},{"Kinshou",0},{"Ginshou",0},{"Keima",0},{"Kyousha",0}
    };
    private GameObject[] NumberArray;
    float x,y,z;
    float mA = 2.0f; //as MoveAmount
    float wolkSpeed = 0.01f;
    int playCredit = 0;
    public Sprite[] changeSprites;
    SpriteRenderer spriteRenderer;


    void Start()
    {
        Application.targetFrameRate = 240;
        FlagOff();//フラグの初期化
        upFlag = true;
        nowKomamei = "Huhyou";
        rb = this.GetComponent<Rigidbody2D>();
        this.spriteRenderer = GetComponent<SpriteRenderer>();
    }

    void Update()//async Task 
    {
        if (Input.GetKeyDown(KeyCode.Q))
        {
            MoveFunction(leftupFlag,-1*mA, mA, 0);
            ChangeFunction("Hisha");
        }
        if (Input.GetKeyDown(KeyCode.W))
        {
            MoveFunction(upFlag,0, mA, 0);
            ChangeFunction("Oushou");
        }
        if (Input.GetKeyDown(KeyCode.E))
        {
            MoveFunction(rightupFlag,mA, mA, 0);
            ChangeFunction("Kakugyou");
        }
        if (Input.GetKeyDown(KeyCode.A))
        {
            MoveFunction(leftFlag,-1*mA, 0, 0);
            ChangeFunction("Kyousha");
        }
        if (Input.GetKey(KeyCode.A))
        {
            if(wolkFlag == true)
            {
                transform.Translate(-1*wolkSpeed,0,0);
            }
        }
        if (Input.GetKeyDown(KeyCode.D))
        {
            MoveFunction(rightFlag,mA, 0, 0);
            ChangeFunction("Keima");
        }
        if (Input.GetKey(KeyCode.D))
        {
            if(wolkFlag == true)
            {
                transform.Translate(wolkSpeed,0,0);
            }
        }
        if (Input.GetKeyDown(KeyCode.Z))
        {
            MoveFunction(leftdownFlag,-1*mA, -1*mA, 0);
            ChangeFunction("Ginshou");
        }
        if (Input.GetKeyDown(KeyCode.X))
        {
            MoveFunction(downFlag,0, -1*mA, 0);
            ChangeFunction("Huhyou");
        }
        if (Input.GetKeyDown(KeyCode.C))
        {
            MoveFunction(rightdownFlag,mA, -1*mA, 0);
            ChangeFunction("Kinshou");
        }
        if (Input.GetKeyDown(KeyCode.S))//Sキーの処理
        {
            if(movePanelFlag == false)
            {
                //フラグの反転
                wolkFlag = !wolkFlag;
                //座標の確認
                Vector3 myPosition = transform.position;
                x = transform.position.x;
                y = transform.position.y;
                z = transform.position.z;
                if(wolkFlag == false)
                {
                    this.OpenKomaPanel();
                }
                else if(wolkFlag == true)
                {
                    this.CloseKomaPanel();
                    //動きの再開
                    StartMove();
                }
            }
        }
        if (Input.GetKeyDown(KeyCode.Space))//スペースキーの処理
        {
            if(komaPanelFlag == false)
            {
                //フラグの反転
                wolkFlag = !wolkFlag;
                //座標の確認
                Vector3 myPosition = transform.position;
                x = transform.position.x;
                y = transform.position.y;
                z = transform.position.z;
                if(wolkFlag == false)
                {
                    this.OpenMovePanel();
                }
                else if(wolkFlag == true)
                {
                    this.CloseMovePanel();
                }
            }
        }
    }

    public void straightMove(float x,float y,float z)//直線的な動き(ぶつかるまで)
    {
        do {
            transform.Translate(x, y, z);
            Debug.Log("Move Now");
        }while(collisionFlag == false);
    }
    public void StopMove()//運動停止
    {
        rb.bodyType = RigidbodyType2D.Kinematic;//動きの固定
        rb.linearVelocity = Vector2.zero;
        rb.angularVelocity = 0f;
    }

    public void StartMove()//運動再開
    {
        rb.bodyType = RigidbodyType2D.Dynamic;
    }

    public void OpenMovePanel()//移動パネルの展開
    {
        movePanelFlag = true;
        //動きを止める
        StopMove();
        //特殊パネルの出現
        currentKomaLine = Instantiate(KomaLine);
        currentKomaLine.transform.position = new Vector3(x,y,z);
        //矢印の出現
        if(upFlag == true)
        {
            currentUpYajirushi = Instantiate(UpYajirushi);
            currentUpYajirushi.transform.position = new Vector3(x,y+1f,z);
        }
        if(rightupFlag == true)
        {
            currentRightUpYajirushi = Instantiate(RightUpYajirushi);
            currentRightUpYajirushi.transform.position = new Vector3(x+0.9f,y+0.9f,z);
        }
        if(leftupFlag == true)
        {
            currentLeftUpYajirushi = Instantiate(LeftUpYajirushi);
            currentLeftUpYajirushi.transform.position = new Vector3(x-0.9f,y+0.9f,z);
        }
        if(downFlag == true)
        {
            currentDownYajirushi = Instantiate(DownYajirushi);
            currentDownYajirushi.transform.position = new Vector3(x,y-1f,z);
        }
        if(rightdownFlag == true)
        {
            currentRightDownYajirushi = Instantiate(RightDownYajirushi);
            currentRightDownYajirushi.transform.position = new Vector3(x+0.9f,y-0.9f,z);
        }
        if(leftdownFlag == true)
        {
            currentLeftDownYajirushi = Instantiate(LeftDownYajirushi);
            currentLeftDownYajirushi.transform.position = new Vector3(x-0.9f,y-0.9f,z);
        }
        if(rightFlag == true)
        {
            currentRightYajirushi = Instantiate(RightYajirushi);
            currentRightYajirushi.transform.position = new Vector3(x+1f,y,z);
        }
        if(leftFlag == true)
        {
            currentLeftYajirushi = Instantiate(LeftYajirushi);
            currentLeftYajirushi.transform.position = new Vector3(x-1f,y,z);
        }
    }

    public void CloseMovePanel()//移動パネルを閉じる
    {
        //動きの再開
        StartMove();
        //タグ(OverLayer)の削除
        DestroyTag("OverLayer");
        movePanelFlag = false;
    }

    public void OpenKomaPanel()//駒パネルの展開
    {
        komaPanelFlag = true;
        //動きを止める
        StopMove();
        //特殊パネルの出現
        currentKomaLine = Instantiate(KomaLine);
        currentKomaLine.transform.position = new Vector3(x,y,z);
        //駒選択肢の出現
        currentKomaOushou = Instantiate(KomaOushou);
        currentKomaOushou.transform.position = new Vector3(x,y+1.1f,z);
        NumberView("Oushou",x,y+1.1f,z);

        currentKomaKakugyou = Instantiate(KomaKakugyou);
        currentKomaKakugyou.transform.position = new Vector3(x+1.1f,y+1.1f,z);
        NumberView("Kakugyou",x+1.1f,y+1.1f,z);

        currentKomaHisha = Instantiate(KomaHisha);
        currentKomaHisha.transform.position = new Vector3(x-1.1f,y+1.1f,z);
        NumberView("Hisha",x-1.1f,y+1.1f,z);

        currentKomaHuhyou = Instantiate(KomaHuhyou);
        currentKomaHuhyou.transform.position = new Vector3(x,y-1.1f,z);
        NumberView("Huhyou",x,y-1.1f,z);

        currentKomaKinshou = Instantiate(KomaKinshou);
        currentKomaKinshou.transform.position = new Vector3(x+1.1f,y-1.1f,z);
        NumberView("Kinshou",x+1.1f,y-1.1f,z);

        currentKomaGinshou = Instantiate(KomaGinshou);
        currentKomaGinshou.transform.position = new Vector3(x-1.1f,y-1.1f,z);
        NumberView("Ginshou",x-1.1f,y-1.1f,z);

        currentKomaKeima = Instantiate(KomaKeima);
        currentKomaKeima.transform.position = new Vector3(x+1.1f,y,z);
        NumberView("Keima",x+1.1f,y,z);

        currentKomaKyousha = Instantiate(KomaKyousha);
        currentKomaKyousha.transform.position = new Vector3(x-1.1f,y,z);
        NumberView("Kyousha",x-1.1f,y,z);
    }

    public void CloseKomaPanel()//駒パネルを閉じる
    {
        //タグ(OverLayer)の削除
        DestroyTag("OverLayer");
        komaPanelFlag = false;
    }

    public void NumberView(string komamei,float x,float y,float z)//所持駒の表示
    {
        NumberArray = new GameObject[]{Instantiate(Number0),Instantiate(Number1),Instantiate(Number2),Instantiate(Number3)
        ,Instantiate(Number4),Instantiate(Number5),Instantiate(Number6),Instantiate(Number7),Instantiate(Number8),Instantiate(Number9)};

        NumberArray[Count[komamei]].transform.position = new Vector3(x,y,z);
    }

    public void MoveFunction(bool flag, float x,float y,float z)
    {
        if(movePanelFlag == true && flag == true && playCredit >= 1)//ここら辺関数化したいね
        {
            wolkFlag = !wolkFlag;
            this.CloseMovePanel();
            if(nowKomamei == "Kakugyou" || nowKomamei == "Hisha" || nowKomamei == "Kyousha")
            {
                straightMove(x,y,z);
            }
            else if (nowKomamei == "Keima")//bug arukamo
            {
                transform.Translate(x-mA,y,z);
                Thread.Sleep(500);
                transform.Translate(x,y,z);
            }
            else
            {
                transform.Translate(x, y, z);
            }
            playCredit--;
        }
    }

    public void ChangeFunction(string komamei)//駒の見た目変更
    {
        if(komaPanelFlag == true && Count[komamei] > 0)
        {
            //フラグの反転
            wolkFlag = !wolkFlag;
            CloseKomaPanel();
            FlagOff();
            ChangeAnimation(komamei);
            Count[komamei]--;
        }
    }

    public void DestroyTag(string tag)//タグ(OverLayer)の削除
    {
        GameObject[] objects = GameObject.FindGameObjectsWithTag(tag);
        foreach(GameObject chinko in objects)
        {
            Destroy(chinko);
        }
    }

    public async Task ChangeAnimation(string komamei)
    {
        wolkFlag = false;
        Vector3 myPosition = transform.position;
        x = transform.position.x;
        y = transform.position.y;
        z = transform.position.z;
        currentkemuri1 = Instantiate(kemuri1);///////配列化して短くできる
        currentkemuri1.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri1);
        currentkemuri1 = null;
        currentkemuri2 = Instantiate(kemuri2);
        currentkemuri2.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri2);
        currentkemuri2 = null;
        currentkemuri3 = Instantiate(kemuri3);
        currentkemuri3.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri3);
        currentkemuri3 = null;
        currentkemuri4 = Instantiate(kemuri4);
        currentkemuri4.transform.position = new Vector3(x,y,z);

        nowKomamei = komamei;//自認の更新
        //変身部分
        switch (komamei)
        {
            case "Oushou":
                this.spriteRenderer.sprite = this.changeSprites[0];
                upFlag = true;
                downFlag = true;
                rightFlag = true;
                leftFlag = true;
                rightdownFlag = true;
                rightupFlag = true;
                leftupFlag = true;
                leftdownFlag = true;
                break;
            case "Kakugyou":
                this.spriteRenderer.sprite = this.changeSprites[1];
                rightdownFlag = true;
                rightupFlag = true;
                leftupFlag = true;
                leftdownFlag = true;
                break;
            case "Hisha":
                this.spriteRenderer.sprite = this.changeSprites[2];
                upFlag = true;
                downFlag = true;
                rightFlag = true;
                leftFlag = true;
                break;
            case "Huhyou":
                this.spriteRenderer.sprite = this.changeSprites[3];
                upFlag = true;
                break;
            case "Kinshou":
                this.spriteRenderer.sprite = this.changeSprites[4];
                upFlag = true;
                downFlag = true;
                rightFlag = true;
                leftFlag = true;
                rightupFlag = true;
                leftupFlag = true;
                break;
            case "Ginshou":
                this.spriteRenderer.sprite = this.changeSprites[5];
                upFlag = true;
                rightdownFlag = true;
                rightupFlag = true;
                leftupFlag = true;
                leftdownFlag = true;
                break;
            case "Keima":
                this.spriteRenderer.sprite = this.changeSprites[6];
                leftupFlag = true;
                rightupFlag = true;
                break;
            case "Kyousha":
                this.spriteRenderer.sprite = this.changeSprites[7];
                upFlag = true;
                break;
            default:
                Debug.Log("Sprite ERRER");
                break;
        }

        await Task.Delay(100);
        Destroy(currentkemuri4);
        currentkemuri4 = null;
        currentkemuri5 = Instantiate(kemuri5);
        currentkemuri5.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri5);
        currentkemuri5 = null;
        currentkemuri6 = Instantiate(kemuri6);
        currentkemuri6.transform.position = new Vector3(x,y,z);
        await Task.Delay(100);
        Destroy(currentkemuri6);
        currentkemuri6 = null;
        //動きの再開
        StartMove();
        wolkFlag = true;
    }
    public void FlagOff()
    {
        upFlag = false;
        downFlag = false;
        rightFlag = false;
        leftFlag = false;
        rightdownFlag = false;
        rightupFlag = false;
        leftupFlag = false;
        leftdownFlag = false;
    }

    void OnTriggerEnter2D(Collider2D collision)//当たった時の判定(Trigger)
    {
        Count[collision.gameObject.tag]++;
        DestroyTag(collision.gameObject.tag);
    }
    void OnCollisionStay2D(Collision2D collision)//衝突している間
    {
        playCredit = 1;
    }
    void OnCollisionEnter2D(Collision2D collision)//衝突した瞬間
    {
        collisionFlag = true;
    }
    void OnCollisionExit2D(Collision2D collision)//離れた瞬間
    {
        collisionFlag = false;
        
    }
    
    
}
